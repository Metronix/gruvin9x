#summary Custom PCB
#labels Phase-Implementation,Phase-Design
<img src="http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcb_v3.2_3d_top.gif" hspace="10" width="320" align="right">
= Custom Main Board Development =

== Why? ==

The primary intention with this new main board is to provide a more powerful and flexible platform for the TH/ER/gruvin9x/(RadioClone?) open source firmware to run on – basically, because we want to and we can. :p (See project home page if you don't know what that even is :-)

The design is "open", so you can follow its progress in all details, as well as make requests and suggestions for additions or improvements – and, of course, you can get involved more directly and do those for yourself. (There are currently two contributors working on the PCB board design.)

Initial intentions were to ...

 * provide a programming header capable of supporting an onboard USB programming board. (For now, this header simply enables connection of an AVR ISP programmer.) *done* 
 * add RS-232 and TTL level telemetry serial data send/receive ports *done*
 * free up most of PORTB for use with an MM/SD card interface for mass storage *done*
 * upgrade the processor for more program, RAM and EEPROM storage memory *done*

The image above (right) is a 3D projection from the computer aided design package we're using -- KiCAD, which is also free and fully open source. So there's no financial excuse for any not to get involved!

There are many ideas coming along. Since Gruvin started the new PC board project, another contributor (Cam) has come along and has already got a nearly completed V4 design completed, with more features, to be announced (it keeps changing as things evolve! :-)

== License ==

The custom board design is licensed under the [http://www.tapr.org/TAPR_Open_Hardware_License_v1.0.txt TAPR Open Hardware License v1.0]. The license is very similar to the GPL of this project's related firmware source code, but includes additional protection against what your author terms, 'hostile patent acts'. In other words, like the GPL license for software source code, the TAPR Open Hardware License seeks to ensure that the openness of the design will endure. The license is NOT a non-commercial license. This design _is_ able to be used by licensees for commercial purposes, under the terms of the [http://www.tapr.org/TAPR_Open_Hardware_License_v1.0.txt OHL License].

== Progress ==

As a starting point, a PCB design was worked up from scratch in [http://kicad.sourceforge.net/ KiCAD] (itself also open source) to closely replicate the wiring and functions of Turnigy V2 '9X logic board. See [http://code.google.com/p/gruvin9x/source/browse/#svn/trunk/pcb/original /trunk/pcb/original/] (as of r155). From there, numerous changes and additions were made -- and continue to be made, as features and versions progress.

The first custom prototype PCB actually built was (somewhat oddly labelled) version 2.14. A few minor bugs were found, additions and changes made and a second custom board design got under way for version 3.

Besides the bug-fixes, a few notable changes were made for V3 ...

 1. The speaker tone generator is now using waveform generator mode on Timer0, output on PB7, which produces much cleaner, smooth sounding tones. Previous internal timing from Timer0 has been moved to Timer2. 

 2. PB7 used to be the LCD back-light control output. This has now been moved to PC0, and appears on a 3-pin break-out with pin spacing to accept the GND/SWITCH/VCC inputs of the [http://smartieparts.com/ SmartieParts.com] LCD back-light driver PCB. This was done to give the back-light driver a convenient home, rather than having to hot-glue it somewhere.

Since then, HobbyKing has come out with a much cheaper [http://www.hobbyking.com/hobbyking/store/uh_viewitem.asp?idproduct=16720 back-light kit] option. That information came to light just a little too late to for the first V3 board run. However, the V4 board design is already set up to use the new HK kit -- in a switchable manner, under firmware control. You will also be able to easily adapt the V3 board to work the same way -- probably by adding a single transistor. More info on that to come.

 3. The original, stock "buzzer" output is retained along with the, now separate speaker output. This make using a speaker optional, and also allows the buzzer output to be used independently for its own beeps and buzzes or to drive a vibrating alert motor. The program code will probably be adjusted such that both speaker and buzzer output work simultaneously. The idea for that being to simply cut one trace to disable the buzzer if you have a speaker, or install a vibrating motor in the buzzer's place.

- - - -

Most of the above comes under conditional code build control. In other words, the project will continue to support the stock (hacked or not) factory controller board, minus the features that require the new board, of course. So the stock board, with the "usual hacks" will still be supported for basic Fr-Sky telemetry.

Here's a (Photoshop'd) KiCAD 3D perspective of the present v3.2 design (image now outdated) ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcb_v3.2_3d_top.gif]

=== V3 will NOT be produced ===

The V3 board still used a 64-pin MCU chip. So in order to free up more pins for other uses (like the SD card) we had to create a scanned-matrix system for getting all fourteen key and trim switches on just eight pins. Unfortunately, that required a lot more dismantling and hacking of the radio hardware than expected. 

But then, along came Cam (in the UK) with his 100-pin variant of the same MCU and all the new board design to go with it. Thus, PCB v4 was born, which is a simple drop-in replacement for the stock PCB -- no hacking required.

I was asked to make a video of the actual v3.2 board that I had hand constructed. Here it is: [http://www.youtube.com/watch?v=V-QUrYAcJOU]

=== The V4 Board (to be produced for resale as soon as possible) ===

Here's a recent V4 visualisation ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcb_v4.x_3d_top.gif]

... looks almost the same -- but looks are often deceiving. :D


== Current Status ==

201108-21: The fist ten V4 prototype boards have arrived in cam's hands. At least two other project followers have asked for blank boards to build up from scratch themselves. Great stuff -- more beta testers! :D

We are _still_ looking for an organisation with the resources and the will to help us do a proper job of manufacturing and supplying these boards -- fully assembled -- to interested customers. HobbyKing.com seems an obvious choice, if we can twist Andy's rubber arm, so to speak. But first, we have to get a completed, tested unit over to him to play with. We hope to be able to do just that before the end of 2011. (HobbyKing do not know about these plans yet, as far as we know.)

In the meantime, we have received several expressions of interest from people wanting to purchase a new controller board for themselves. *But we are not currently accepting pre-orders*. We need to wait until, a) the V4 board is tested to be without errors and b) a fair and proper mechanism for placing orders is available. We're working on it. Please be patient. 

*Past Milestones in descending date order ...*

2011-07-07: First test run V3 PC boards confirmed in production.

2011-07-04: New SD card board (smaller/better size) sent away for production. Also, Cam has made an alternative design for UK builders who, like him, cannot find local stock for the SD card socket used in the previous design.

2011-06-25: SD card PCB assembled, installed and test OK. Physical size of board found to be 8mm too long for its decided installation position and the SD card socket should protrude beyond the board edge by 2.5mm also. Changes made to the design accordingly, awaiting ordering process. (Real Time Clock (RTC) on the same board also tested and working.)

2011-06-01: SD card prototype PCBs arrive. Construction begins, noting that the custom component pads are all perfectly correct. Yay \o/.

2011-01-14: First prototype board fully constructed, code updated and functioning. There were some issues with the wiring layout of the trim switches that will need to be fixed on the V3 board. But otherwise, everything seems to be working.  All in all, it doesn't make much sense to produce another V2 prototype board, since the V3 board will include several fixes and enhancements.

Next step is probably going to be to take advantage of the extra Flash space (now 256KBytes) and start playing with MM/SDCARD mass storage.

2010-12-30: Components and PCBs have arrived (ahead of schedule). Have ordered components to make up the 'plug' end of the 2-way, 3-way and 8-way JST sockets, which I had thought were included with same. I'm elated to report that the PCB mounting holes and push-button-switch physical locations are within spec and fit well into the actual radio '9X cabinet. (That had been one of my greater concerns during the design process.)

2010-12-22: [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen/production/gruvin9x-bom.xls  Components] to build three prototypes ordered from Digikey.com

2010-12-15: A first batch of 10 (MOQ) prototype PCB's ([http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen rev2.14]) ordered.

== Schematics ==

=== PostScript and PDF Files ===

 * New gruvin9x custom Main PCB rev2.14 (production frozen) - [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen/gruvin9x.pdf PDF] | [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen/gruvin9x.ps PS]
 * Stock V2 Main PCB - [http://gruvin9x.googlecode.com/svn/trunk/pcb/actual_v2_9x/gruvin9x_v2_actual.pdf PDF] | [http://gruvin9x.googlecode.com/svn/trunk/pcb/actual_v2_9x/gruvin9x_v2_actual.ps PS]
 * Hacked V2 Main PCB - [http://gruvin9x.googlecode.com/svn/trunk/pcb/hacked/gruvin9x-hacked.pdf PDF] | [http://gruvin9x.googlecode.com/svn/trunk/pcb/hacked/gruvin9x-hacked.ps PS] (Speaker, Fr-Sky telemetry RXD and USART1 freed - hacked unit IE. not a new PCB.)


== KiCAD Circuit Schematic and PCB Files ==

Ongoing circuit/PCB work (snapshots as and when uploaded) reside at [http://code.google.com/p/gruvin9x/source/browse/#svn/trunk/pcb/original /trunk/pcb/]

To download all the PCB design related files only (without project source, docs, etc) ...

{{{
svn checkout http://gruvin9x.googlecode.com/svn/trunk/pcb gruvin9x-pcb
}}}

... or just check out or update the full trunk

... or of course you can use the Google Code 'browse' link above to find them that way.

== Preview ==

2010-12-02: A final draft of the PCB based on [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.1/gruvin9x_rev21.pdf schematic rev2.1] has been completed. (All files updated in `/trunk/pcb` as at r159). I'm waiting on some peer review and comments before committing this to a manufacturer. Time frame unknown.

The board includes the total re-wire of all trim and button switches into a 4x4 scanned matrix to free up most of Port B. This gives us dedicated I/O ports for the MMC/SDCARD and a couple spares as well -- with theoretically only very minor CPU load for scanning the inputs. 

The connector for the MMC/SDCARD interface can be seen at lower/middle of the image below. The two connectors to the lower right are the TTL and RS-232 level telemetry TX/RX ports. A 2-pin connector on the upper edge is for the left-hand and right-hand trim switch 'common' connections. These replace their respective connections to ground, in order to work with the new 4x4 input matrix.

This new main board will receive an *ATmega2561* (256K Flash, 4K EEPROM, 8K SRAM). I have thus far decided to keep ATmega running at 5V, though it's certainly tempting to move down to 3.3V, since the LCD screen and SDCARD currently need a total of 31 resistors just to down-convert the voltage! However, I'm concerned about possible noise increase on the ADC inputs, should the operating voltage be lowered, and a couple of other minor issues too. So at 5 Volts we stay.

*The 3D image from KiCAD* as at r155 ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-r21-3d-top.jpg]

NOTE: Since moved on to rev2.11 with a few minor changes/additions, like RF decoupling caps on the KEYXn inputs and some tidying up here and there. Work continues! :-D 


=== Previously ===

NOTE: These images (below) as at r122 ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/PCB-final-mock.jpg]

The above image is merely a PhotoShop mock-up based on the various layer outputs from KiCAD. 

=== Cost ===

The present best quote for low volume PCB manufacture is around the USD$15 mark -- for one of 10 boards with no components installed. Manufacturing of a prototype board will likely not happen until at least the telemetry and mass storage mods have been done. That will include break-outs for any remaining spare port pins and should get the hardware to a point where nothing additional is needed. 

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-3d-top.jpg]

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-3d-bottom.jpg]