#summary Custom PCB
#labels Phase-Implementation,Phase-Design
<img src="http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcbv4_photo.jpg" hspace="10" width="320" align="right">
= Custom Main Board Development =

Finally -- blank v4.1 boards are now in stock and available for purchase at [http://gruvin9x.com/shop]. There also a version with the MCU and LCD ZIF socket pre-soldered, while stocks last.

_Photo to the right is the v4.0 prototype (R.I.P). An image of the V4.1 board can be found below, in the 'Progress' section._

== Why? ==

The primary intention with this new main board is to provide a more powerful and flexible platform for the TH/ER/gruvin9x/(RadioClone?) open source firmware to run on – basically, because we want to and we can. :p (See project home page if you don't know what that even is :-)

The design is "open", so you can follow its progress in all details, as well as make requests and suggestions for additions or improvements – and, of course, you can get involved more directly and do those for yourself. (There are currently two contributors working on the PCB board design.)

Initial intentions were to ...

 * provide a programming header capable of supporting an onboard USB programming board. (For now, this header simply enables connection of an AVR ISP programmer.) *done* 
 * add RS-232 and TTL level telemetry serial data send/receive ports *done*
 * free up most of PORTB for use with an MM/SD card interface for mass storage *done*
 * upgrade the processor for more program, RAM and EEPROM storage memory *done* (v3.2)
 * upgrade processor yet again to 100-pin version, for even greater "plug'n'play" flexibility. *done* (v4.0)

Thanks to the enthusiastic support of several people over the months, there have been many ideas to come along since those first intentions were realized. These include ...

 * USB port for potential 'game controller' interface -- for use with PC flight simulators, giving access to all switches and rotary inputs controls. _`[` Sadly, a USB boot loader cannot happen due to space needed for SD card version of the same.`]`_
 * SD card boot loader. This would allow re-Flashing by simply copying the firmware file to the SD card. No more programmers or cables to connect and get working.
 * Two continuous rotation control dials with push switch action (rotary encoders) for improved menu navigation, value settings and in flight adjustment (yet to be coded.)
 * At least eleven (11) spare I/O ports including three ADC inputs for uses mostly not even planned yet.
 * Onboard support for both the Smartieparts.com EL backlight board and also now a dedicated LED backlight regulator.
 * Support for both the stock buzzer and a variable tone speaker at the same time, as well as a separate vibrator motor port with it's own regulated supply.
 * JTAG programming/debug port in addition to the separate SPI programming port. (Should prove invaluable for the code developers.)
 * RS232 and TTL level telemetry data interface, supporting shared simultaneous three-way connection with a host computer for debugging and analysis
 * Onboard precision voltage reference to improve safety main battery voltage monitoring over the Atmega's slow-to-stabalise internal band gap reference.
 * A theoretically much more robust and multi-vendor compatible trainer port circuit, hopefully meaning that your upgraded '9X will work seamlessly with just about any other make of radio currently on the market.
 
... and more besides.

*Why not an ARM chip?* 

We looked at basing the new board around a STM32 ARM based chip. But we decided against this, for a number of reasons. The ATmega2560 chip will do everything we need with the confidence that our highly timing-sensitive code is already tested and reliable on the ATmega platform. 

When we want more CPU power, say for on-board wireless video feed processing and other advanced features we have in mind, then we're more likely to add a second processor, so as to maintain the required high reliability of the core function -- that is, solid and safe remote control of our models.

== License ==

The custom board design is licensed under the [http://www.tapr.org/TAPR_Open_Hardware_License_v1.0.txt TAPR Open Hardware License v1.0]. The license is very similar to the GPL of this project's related firmware source code, but includes additional protection against what your author terms, 'hostile patent acts'. In other words, like the GPL license for software source code, the TAPR Open Hardware License seeks to ensure that the openness of the design will endure. The license is NOT a non-commercial license. This design _is_ able to be used by licensees for commercial purposes, under the terms of the [http://www.tapr.org/TAPR_Open_Hardware_License_v1.0.txt OHL License].

== Where it Started ==

As a starting point -- and in fact initially only as a test case to help learn to use the CAD software -- a PCB design was worked up from scratch in [http://kicad.sourceforge.net/ KiCAD] (itself also open source) to closely replicate the wiring and functions of Turnigy V2 '9X logic board. See [http://code.google.com/p/gruvin9x/source/browse/#svn/trunk/pcb/original /trunk/pcb/original/] (as of r155). From there, things just kept growing, with numerous changes and additions being made, until eventually an actual new board ended up being produced.

The first custom prototype PCB actually built was (somewhat oddly) named, "version 2.14". This was Gruvin's first ever PCB using tiny surface mount components and a lot was learned through the exercise. That said, the board fired up and worked from the moment power was first connected, which was quite astonishing at the time, to say the least! A few minor bugs were found, additions and changes made and another design quickly got underway.

Version 3.2 used the same ATmega2561 chip, which was an upgrade over the original but with still only 64 pins. At the time, Gruvin was basically too scared to attempt a design for the 100 pin ATmega2560 version of the chip. As fate would have it however, a British gent by the name of Cameron happened across the project and asked if he might have a crack at the 100 pin design. "Well sure you can!" The rest is now history and as of 2011-09-13, we're about to start beta testing custom PCB version 4, which will finally (most hopefully) be offered up for retail, as a fully assembled unit. (As of said date, the first v4 test board is already up and running with no bugs yet found.)

- - - -

  I was asked to make a video of the actual v3.2 board that I had hand constructed.
  Here it is ...

  <wiki:video url=http://www.youtube.com/watch?v=V-QUrYAcJOU/> -- gruvin (on a bad hair day.)

  Note: Video is X-Y mirrored, for some strange reason.

  - - - -

  And here I am again, flipped 'round the right way this time, showing the v4.1 board ...

  <wiki:video url=http://www.youtube.com/watch?v=msiBt5J-OHc/>


== Progress ==
=== The V4.1 Board -- Now Available ===

The v4.1 (final v4 production version) board is now available for purchase at [http://gruvin9x.com/shop]. We encourage all early adopters and home electronics constructors to grab yourselves a board or two and get building. :-D We'll be here to assist with any problems.

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcbv41_photo.jpg]

A high resolution version of the above photo is available [http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcbv41_photo_fs.jpg here].

Interestingly, this board was mainly constructed through concurrent, ambidextrous use of two hand soldering irons (one in each hand), to transfer components from the v4.0 prototype to the new v4.1 PCB. The process took about four hours in total. One resistor was apparently heat-damaged and needed replacing. Everything else seems to be working 100%. Yay \o/

The back of the board has the HobbyKing LED back-light kit supplied self-adhesive foam pad stuck to it. I would recommend that specific LED back-light kit to all V4.1 board adopters. There's a dedicated driver output for it at the upper right of the board. _Be SURE to use the center GND and *RIGHT*-hand pin to get the current limited LED-safe connection_ -- because the left terminal is a full current, 5V supply!

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcbv41_photo_back.jpg]

=== The v4.0 Prototype Board ===

Here's a recent V4.0 3D visualization from KiCAD...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/pcb_v4.x_3d_top.gif]

== Current Status ==

2011-12-08: First v4.1 board fully built and tested all OK. Boards in stock and available for purchase at [http://gruvin9x.com/shop]

2011-11-16: v4.1 blank production boards have arrived. Also, v4.1 factory assembled 'beta' boards are underway and expected before Christmas.

2011-10-11: We are satisfied that the v4.1 board is ready for its first test factory production run of ten Beta test boards. All of the testing is finished and the bugs found have been corrected. Meanwhile, we continue to develop and test on the three existing and working v4.0 boards, which have all been patched using track-cuts and wire links to the new v4.1 bug-fixed design version. It is likely that Cam will finalise the decision to freeze and deliver the v4.1 design to Leo for factory processing within the next 24 hours.

2011-09-22: A number of circuitry bugs have been found and corrected, as testing continues on schedule. Four v4.0 boards are known to exist at this time. We expect to be ordering the first small factory test batch by mid October, but will not rush the date if all testing has not been completed satisfactorily.

2011-09-13: The first v4.0 beta test board was assembled and powered up by Gruvin in New Zealand, who was excited to see it perform all its primary functions without fault, right from the get go! :-D The additional v4 features are yet to be tested. There are two or three others at different locations around the globe also building the same v4 board as this is being typed. Assuming all goes well, thanks to a generous donation offered by Swiss supporter, Leo, ten v4.1 boards are planed to be factory assembled in China, with about half of those being offered at near cost to the first group of beta testers outside of the core project team. If all that goes well, then we plan to try and raise funds for assembly batches of 50 to 100 boards at a time, with a target retail price of around USD$149. No promises can be made at this stage.

*Past Milestones in descending date order ...*

2011-08-21: The fist ten (blank) V4 prototype boards have arrived in cam's hands. At least two other project followers have asked for blank boards to build up from scratch themselves. Great stuff -- more beta testers! :D

In the meantime, we have received several expressions of interest from people wanting to purchase a new controller board for themselves. *But we are not currently accepting pre-orders*. We need to wait until, a) the V4 board is tested to be without errors, b) the Chinese manufacturer lined up to assemble the small quantities of boards involved has proven practical and c) a fair and proper mechanism for placing orders is available. We're working on it. Please be patient. We do hope to have assembled and tested boards available before the end of 2011.

2011-07-07: First test run V3 PC boards confirmed in production.

2011-07-04: New SD card board (smaller/better size) sent away for production. Also, Cam has made an alternative design for UK builders who, like him, cannot find local stock for the SD card socket used in the previous design.

2011-06-25: SD card PCB assembled, installed and test OK. Physical size of board found to be 8mm too long for its decided installation position and the SD card socket should protrude beyond the board edge by 2.5mm also. Changes made to the design accordingly, awaiting ordering process. (Real Time Clock (RTC) on the same board also tested and working.)

2011-06-01: SD card prototype PCBs arrive. Construction begins, noting that the custom component pads are all perfectly correct. Yay \o/.

2011-01-14: First prototype board fully constructed, code updated and functioning. There were some issues with the wiring layout of the trim switches that will need to be fixed on the V3 board. But otherwise, everything seems to be working.  All in all, it doesn't make much sense to produce another V2 prototype board, since the V3 board will include several fixes and enhancements.

Next step is probably going to be to take advantage of the extra Flash space (now 256KBytes) and start playing with MM/SDCARD mass storage.

2010-12-30: Components and PCBs have arrived (ahead of schedule). Have ordered components to make up the 'plug' end of the 2-way, 3-way and 8-way JST sockets, which I had thought were included with same. I'm elated to report that the PCB mounting holes and push-button-switch physical locations are within spec and fit well into the actual radio '9X cabinet. (That had been one of my greater concerns during the design process.)

2010-12-22: [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen/production/gruvin9x-bom.xls  Components] to build three prototypes ordered from Digikey.com

2010-12-15: A first batch of 10 (MOQ) prototype PCB's ([http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.14-frozen rev2.14]) ordered.

== Schematics and PCB Design Files ==

See the [Circuitry Custom Schematics] page for details.


= Historical Data =
== Preview ==

2010-12-02: A final draft of the PCB based on [http://gruvin9x.googlecode.com/svn/trunk/pcb/rev2.1/gruvin9x_rev21.pdf schematic rev2.1] has been completed. (All files updated in `/trunk/pcb` as at r159). I'm waiting on some peer review and comments before committing this to a manufacturer. Time frame unknown.

The board includes the total re-wire of all trim and button switches into a 4x4 scanned matrix to free up most of Port B. This gives us dedicated I/O ports for the MMC/SDCARD and a couple spares as well -- with theoretically only very minor CPU load for scanning the inputs. 

The connector for the MMC/SDCARD interface can be seen at lower/middle of the image below. The two connectors to the lower right are the TTL and RS-232 level telemetry TX/RX ports. A 2-pin connector on the upper edge is for the left-hand and right-hand trim switch 'common' connections. These replace their respective connections to ground, in order to work with the new 4x4 input matrix.

This new main board will receive an *ATmega2561* (256K Flash, 4K EEPROM, 8K SRAM). I have thus far decided to keep ATmega running at 5V, though it's certainly tempting to move down to 3.3V, since the LCD screen and SDCARD currently need a total of 31 resistors just to down-convert the voltage! However, I'm concerned about possible noise increase on the ADC inputs, should the operating voltage be lowered, and a couple of other minor issues too. So at 5 Volts we stay.

*The 3D image from KiCAD* as at r155 ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-r21-3d-top.jpg]

NOTE: Since moved on to rev2.11 with a few minor changes/additions, like RF decoupling caps on the KEYXn inputs and some tidying up here and there. Work continues! :-D 


=== Previously ===

NOTE: These images (below) as at r122 ...

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/PCB-final-mock.jpg]

The above image is merely a PhotoShop mock-up based on the various layer outputs from KiCAD. 

=== Cost ===

The present best quote for low volume PCB manufacture is around the USD$15 mark -- for one of 10 boards with no components installed. Manufacturing of a prototype board will likely not happen until at least the telemetry and mass storage mods have been done. That will include break-outs for any remaining spare port pins and should get the hardware to a point where nothing additional is needed. 

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-3d-top.jpg]

[http://gruvin9x.googlecode.com/svn/wiki/PCB.attach/kicad-pcb-3d-bottom.jpg]